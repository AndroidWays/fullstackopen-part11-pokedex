name: Pokedex App Health Monitor

on:
    schedule:
        - cron: '0 */6 * * *' # Every 6 hours
    workflow_dispatch:

env:
    APP_URL: 'https://your-pokedex-app.onrender.com' # Replace with your actual URL

jobs:
    status-check:
        runs-on: ubuntu-latest
        steps:
            - name: Check system status
              id: status-check
              run: |
                  # Store current timestamp
                  echo "CHECK_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

                  # Health check
                  HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.APP_URL }}/health)
                  echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT

                  # E2E test (example - replace with your actual test command)
                  npm run test:e2e && echo "e2e_status=success" >> $GITHUB_OUTPUT || echo "e2e_status=failed" >> $GITHUB_OUTPUT

                  # Other tests (example)
                  npm run test && echo "other_tests_status=success" >> $GITHUB_OUTPUT || echo "other_tests_status=failed" >> $GITHUB_OUTPUT

                  # Deployment status (example)
                  curl -s ${{ env.APP_URL }} | grep -q "Pokedex" && echo "deployment_status=success" >> $GITHUB_OUTPUT || echo "deployment_status=failed" >> $GITHUB_OUTPUT

                  # Version check (example)
                  VERSION=$(curl -s ${{ env.APP_URL }}/version | jq -r .version)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Send status report to Discord
              uses: actions/github-script@v6
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
              with:
                  script: |
                      const statusEmoji = (status) => status === 'success' ? '✅' : '❌';

                      await fetch(process.env.DISCORD_WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                          username: 'Pokedex Status Bot',
                          avatar_url: 'https://cdn-icons-png.flaticon.com/512/188/188987.png',
                          embeds: [{
                            title: '📊 Pokedex System Status',
                            color: 5763719,  # Green
                            description: [
                              `🔹 Triggered by: ${'${{ github.event_name }}' === 'schedule' ? 'schedule' : 'manual'}`,
                                  `🔹 Health status: ${statusEmoji('${{ steps.status-check.outputs.health_status }}' === '200' ? 'success' : 'failed')} ${'${{ steps.status-check.outputs.health_status }}' === '200' ? 'success' : 'failed'}`,
                                  `🔹 E2E Tests: ${statusEmoji('${{ steps.status-check.outputs.e2e_status }}')} ${'${{ steps.status-check.outputs.e2e_status }}'}`,
                                  `🔹 Other tests: ${statusEmoji('${{ steps.status-check.outputs.other_tests_status }}')} ${'${{ steps.status-check.outputs.other_tests_status }}'}`,
                                  `🔹 Deployment: ${statusEmoji('${{ steps.status-check.outputs.deployment_status }}')} ${'${{ steps.status-check.outputs.deployment_status }}'}`,
                                  `🔹 Version: ${'${{ steps.status-check.outputs.version }}' || 'N/A'}`
                            ].join('\n'),
                            footer: {
                              text: 'Checked at: ${{ env.CHECK_TIME }}'
                            }
                          }]
                        })
                      });
